#cloud-config

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - software-properties-common

runcmd:
  # Add Kubernetes repository GPG key
  - curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg

  # Add Kubernetes repository
  - echo "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | tee /etc/apt/sources.list.d/kubernetes.list

  # Update package lists
  - apt-get update

  # Install Kubernetes packages
  - apt-get install -y kubeadm kubelet kubectl

  # Enable and start kubelet service
  - systemctl enable kubelet
  - systemctl start kubelet

  # Enable firewall
  - ufw enable

  # Configure firewall rules
  - ufw allow 22/tcp  # SSH
  - ufw allow 6443/tcp  # Kubernetes API server
  - ufw allow 2379:2380/tcp  # Etcd server client API
  - ufw allow 10250/tcp  # Kubelet API
  - ufw allow 10251/tcp  # kube-scheduler
  - ufw allow 10252/tcp  # kube-controller-manager
  - ufw allow 179/tcp  # Calico BGP
  - ufw allow 4789/udp  # Calico BGP
  - ufw allow 9099/tcp  # Calico health check
  - ufw allow 2379:2380/tcp  # Etcd server client API
  - ufw allow 2381/tcp  # Portworx
  - ufw allow 9001/tcp  # Portworx
  - ufw allow 9015/tcp  # Portworx
  - ufw reload # reload the firewall

write_files:
  - path: /etc/kubernetes/config
    owner: root:root
    permissions: '0644'
    content: |
      apiVersion: kubeadm.k8s.io/v1beta2
      kind: ClusterConfiguration
      networking:
        podSubnet: "10.244.0.0/16"
